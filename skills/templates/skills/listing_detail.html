{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">

  <!-- Listing Card Header -->
  <div class="card shadow-sm mb-4">
    <div class="row g-0 align-items-center">

      <!-- Combined Profile + Listing Photos Carousel -->
      <div class="col-12 col-md-3">
        <div id="listingCarousel" class="carousel slide rounded-start h-100" data-bs-ride="carousel">

          <div class="carousel-inner h-100" style="background-color: #f8f9fa;">

            {# --- First slide: provider profile image --- #}
            <div class="carousel-item active">
              {% if listing.provider.profile_image %}
              <img src="{{ listing.provider.profile_image.url }}" class="d-block w-100 h-100"
                alt="{{ listing.provider.display_name }}" style="object-fit: contain;">
              {% else %}
              <img src="{% static 'images/default-profile.jpg' %}" class="d-block w-100 h-100" alt="Default profile"
                style="object-fit: contain;">
              {% endif %}
            </div>

            {# --- Subsequent slides: listing photos --- #}
            {% for p in photos %}
            <div class="carousel-item">
              <img src="{{ p.url }}" class="d-block w-100 h-100" alt="Listing photo {{ forloop.counter }}"
                style="object-fit: contain;">
            </div>
            {% endfor %}
          </div>

          {% if photos %}
          <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
          {% endif %}
        </div>
      </div>


      <!-- Listing Info -->
      <div class="col-12 col-md-8">
        <div class="card-body">
          <h3 class="card-title mb-2">{{ listing.skill.name }}</h3>
          <p class="card-text mb-1"><strong>Provider:</strong> {{ listing.provider.display_name }}</p>
          <p class="card-text mb-1">
            <strong>Location:</strong>
            {% if listing.location %}{{ listing.location.name }}{% else %}Not set{% endif %}
          </p>

          <p class="card-text mt-3"><strong>Price:</strong> £{{ listing.price }}</p>

          {% if listing.avg_rating %}
          <div class="mt-2">
            <span class="badge text-bg-warning text-dark">{{ listing.avg_rating|floatformat:1 }}/5</span>
            <small class="text-muted">({{ listing.review_count }} review{{ listing.review_count|pluralize }})</small>
          </div>
          {% else %}
          <small class="text-muted">No reviews yet</small>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Bio and Description -->
  <div class="card card-body shadow-sm mb-4">
    <h5>About the Provider</h5>
    <p class="mb-3">{{ listing.provider.bio|default:"(No bio provided)" }}</p>

    <h5>Description</h5>
    <p>{{ listing.description|default:"(No description set)" }}</p>

    <h5>Price</h5>
    <p>£{{ listing.price }}</p>
  </div>

  <!-- Messages -->
  <div class="d-flex flex-wrap gap-3 mb-4">
    {% if user.is_authenticated %}
    {% if user.profile != listing.provider %}
    <a href="{% url 'start_conversation' listing.id %}" class="btn btn-primary">
      Message Provider
    </a>
    <a href="#reviewForm" class="btn btn-outline-primary">
      Leave a Review
    </a>
    {% else %}
    <span class="text-muted">This is your listing.</span>
    {% endif %}
    {% else %}
    <a href="{% url 'account_login' %}?next={% url 'listing_detail' listing.id %}" class="btn btn-primary">
      Log in to message provider
    </a>
    {% endif %}
  </div>


  <!-- Reviews Section -->
  <h4 class="mb-3">Reviews</h4>

  <!-- Average Rating -->
  <p class="mb-2">
    <strong>Average rating:</strong>
    {% if rating_stats.count %}
      {% for i in "12345" %}
        {% if forloop.counter <= avg_rating_int %}
          <span class="text-warning">★</span>
        {% else %}
          <span class="text-muted">★</span>
        {% endif %}
      {% endfor %}
    <span class="text-muted">
      ({{ rating_stats.avg|floatformat:1 }}/5 from {{ rating_stats.count }} review{{ rating_stats.count|pluralize }})
    </span> 
    {% else %} 
    <span class="text-muted">No reviews yet.</span> 
    {% endif %} </p>

  <!-- Review Form -->
  {% if review_form %}
  <div class="card card-body shadow-sm mb-3">
    <h5 class="mb-3">
      {% if user_review %}Edit Your Review{% else %}Leave a Review{% endif %}
    </h5>

    <form method="post">
      {% csrf_token %}

      <!-- Star Input -->
      <div class="mb-3">
        <label class="form-label mb-2">Your Rating:</label>
        <div class="star-rating">
          {{ review_form.rating.label_tag }} 
          {{ review_form.rating }}
        </div>
      </div>

      <div class="mb-3">
        {{ review_form.comment.label_tag }}
        {{ review_form.comment }}
      </div>

      <button class="btn btn-primary" type="submit">
        {% if user_review %}Update Review{% else %}Submit Review{% endif %}
      </button>
    </form>
  </div>

  {% elif user.is_authenticated and listing.provider == user.profile %}
  <p class="text-muted">You can’t review your own listing.</p>

  {% elif user.is_authenticated and not can_review %}
  <p class="text-muted">
    You can only leave a review after participating in a conversation with this provider.
    <a href="{% url 'start_conversation' listing.id %}" class="text-decoration-none">
      Message provider now.
    </a>
  </p>

  {% else %}
  <p><a href="{% url 'account_login' %}">Log in</a> to leave a review.</p>
{% endif %}

  <!-- Reviews List -->
  {% for r in reviews %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <strong>{{ r.reviewer.display_name }}</strong>
        <div class="review-stars">
          {% for i in "12345" %}
            {% if forloop.counter <= r.rating %}
              <span class="text-warning">★</span>
            {% else %}
              <span class="text-muted">★</span>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      {% if r.comment %}
        <p class="mt-2 mb-1">{{ r.comment }}</p>
      {% endif %}

      <small class="text-muted">{{ r.created_at|date:"M j, Y" }}</small>
    </div>
  </div>
{% empty %}
  <p>No reviews yet.</p>
{% endfor %}


  <p class="mt-3"><a href="{% url 'home' %}" class="text-decoration-none">&larr; Back to home</a></p>
</div>
{% endblock %}